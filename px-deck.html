<link rel="import" href="../polymer/polymer.html"/>
<dom-module id="px-deck">
    <template>
        <div style="border:blue 3px solid;">
            <h1>Deck:<span>{{context.name}}</span></h1>
            <content></content>
        </div>
    </template>
</dom-module>
<script>
    window.px = window.px || {};

    window.addEventListener('px-dashboard-ready', function() {
        //console.log('window received px-dashboard ready');
        document.querySelector('px-dashboard').init();
    });

    px.deck = {
        properties: {
            context: {
                type: Object,
                observer: 'contextChanged'
            }
        },
        contextChanged: function(thing) {
            //console.log('itchanged', thing);
            var self = this;
            this.cards.forEach(function(card) {
                //console.log('pushing this context', self.context);
                card.context = self.context;
            });
        },
        created: function() {
            this.cards = [];
            //console.log('----> deck-created!!');
            var self = this;
            this.addEventListener('px-card-ready', function(e) {
                //console.log('deck received px-card-ready <----');
                self.fire('px-deck-ready');
                self.registerCardInDeck(e.target);
            });
        },
        ready: function() {
            //console.log('----------> deck-ready!!');
            this.state = {};
        },
        attached: function() {
            //console.log('----> deck-attached!!');
        },
        init: function() {
            //console.log('px-deck init is called');
        },
        updateState: function(cardId, state) {
            var newState = {};
            Polymer.Base.mixin(newState, this.state);
            Polymer.Base.mixin(newState, state);
            this.state = newState;

            var self = this;
            this.cards.forEach(function(card) {
                // only update cards with different ids
                if (card.id !== cardId) {
                    card.set('deckState', self.state);
                }
            });
        },
        registerCardInDeck: function(card){
            card._deck = this;
            card.init(this);
            this.cards.push(card);
        },
        addCard: function(cardName, cardId) {
            if(!cardName || !cardId) {
                throw 'Add card must be called with a card name and card id';
            }
            var newCard = document.createElement('sample-card');
            newCard.setAttribute('id', cardId);
            Polymer.dom(this).appendChild(newCard);
        },
        removeCardById: function(cardId){
            if(!cardId) {
                throw 'Remove card by id must be called with a card id';
            }
            var card = Polymer.dom(this).querySelector('#'+cardId);
            if (!card){
                console.warn('Cannot find card by id '+cardId);
                return;
            }
            Polymer.dom(this).removeChild(card);
        }
    };

    Polymer({
        is: 'px-deck',
        behaviors: [px.deck]
    });

</script>



