<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../iron-ajax/iron-ajax.html"/>

<dom-module id="px-dashboard">
    <template>
        <div id="container"></div>
        <iron-ajax
            auto
            url="{{deckUrl}}"
            handle-as="text"
            on-response="handleResponse"></iron-ajax>
    </template>
</dom-module>
<script>
    window.px = window.px || {};
    px.dealer = px.dealer || {};
    px.dealer.loadedDecks = px.dealer.loadedDecks || {};

    px.dashboard = {
        properties: {
            selectedView: {
                type: String,
                observer: "viewSelected"
            },
            context: {
                type: Object,
                observer: "contextChanged"
            }
        },
        viewSelected: function(newView) {
            if (newView && newView.substring(0, 2) !== '{{') {
                //console.log('new view switch deck', newView);
                this.switchDeck(newView);
            }
        },
        contextChanged: function(newContext) {
            //console.log('NEWCONTEXT', newContext);
            var deck = document.querySelector('px-deck');
            if (deck) {
                deck.context = this.context;
            }
        },
        created: function() {
            //console.log('----> dashboard-created!!');
            this.addEventListener('px-deck-ready', function() {
                //console.log('dashboard received px-deck-ready <----');
                this.fire('px-dashboard-ready');
            });
        },
        ready: function() {
            //console.log('----------> dashboard-ready!!');
        },
        attached: function() {
            //console.log('----> dashboard-attached!!');
        },
        init: function() {
//            console.log('px-dashboard init is called (does nothing)');
        },
        switchDeck: function(url) {

            var container = this.$.container;
            if (container) {
                container.innerHTML = "";
//                if (!px.dealer.loadedDecks[url]) {
                    this.deckUrl = url;
//                }
//                else {
//                    container.innerHTML = px.dealer.loadedDecks[url];
//                    document.querySelector('px-deck').context = this.context;
//                }
            }
            else {
                console.log('there is no container');
            }
        },
        handleResponse: function(e) {
            var deck = e.detail.response;
            var container = this.$.container;
            container.innerHTML = deck;
            px.dealer.loadedDecks[url] = deck;
            container.querySelector('px-deck').context = this.context;
        }
    };

    Polymer({
        is: 'px-dashboard',
        behaviors: [px.dashboard]
    });

</script>
