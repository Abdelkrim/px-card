

<!--
@blurb px card behavior or card api
-->

<script type="text/javascript">
    //px-card interface/behavior
    (function() {
        window.px = window.px || {};

        window.px.cardBehavior = {
            properties: {
                context: {
                    type: Object,
                    observer: '_contextChanged',
                  reflectToAttribute: true
                },

                deckState: {
                    type: Object,
                    observer: '_deckStateChanged',
                  reflectToAttribute: true
                }
            },

            _contextChanged: function(newContext, oldContext) {
              //execute callback, if any
              if (this.contextChanged && typeof this.contextChanged === 'function') {
                  this.contextChanged(newContext, oldContext);
              }
            },


            _deckStateChanged: function(newDealerState, oldDealerState) {
              this.fromDealer = true;
              //execute callback, if any
              if (this.deckStateChanged && typeof this.deckStateChanged === 'function') {
                  this.deckStateChanged(newDealerState, oldDealerState);
              }

              this.fromDealer = false;
            },


            _refresh: function() {
              console.log("refresh");
                if (this.refresh && typeof this.refresh === 'function') {
                    this.refresh();
                }
            },

          created: function() {
            this._type = 'px-card';
          },


            ready: function() {
              this.addEventListener('px-card-refresh', this._refresh);
              this.fire('px-card-ready');

            },

          attached: function() {
            var propName;

            if (this.hasAttributes()) {
              for (var i = 0; i < this.attributes.length; i++) {
                propName = Polymer.CaseMap.dashToCamelCase(this.attributes[i].name);
                //var _this = this;
//                  this[propName + "NestedLightDomBindingObserver"] = function(newValue, oldValue) {
//                    if (newValue !== oldValue) {
//                      //set context on dom-bind nested templates from light dom, if any
//                      _this.updateNestedLightDomBindings(propName, newValue);
//                    }
//                  };
//                  console.log(this.tagName + " " + this.className + " " + propName + "NestedLightDomBindingObserver = " + this[propName + "NestedLightDomBindingObserver"]);
//                  this._addObserverEffect(propName, propName + "NestedLightDomBindingObserver");
                this.updateNestedLightDomBindings(propName, this[propName]);
              }
            }

          },

          attributeChanged: function(name, type) {
            var propName = Polymer.CaseMap.dashToCamelCase(name);
            this.updateNestedLightDomBindings(propName, this[propName]);
          },


            init: function(){
                // this default init function is needed in case they don't implement init
            },

          updateNestedLightDomBindings: function(key, value) {
            var transcludedNodes = Polymer.dom(Polymer.dom(this.root).querySelector("content")).getDistributedNodes();
            transcludedNodes.forEach(function(node) {
              if (node.getAttribute && node.getAttribute("is") === "dom-bind" && node.set) {
                node.set(key, value);
              }
            })
          },


            updateDeck: function(value) {
                if (!this.fromDealer) {
                    if (this._dealer && this._dealer.updateState) {
                        this._dealer.updateState(this.id, value);
                    }
                    else {
                        //console.log('no updatestate');
                    }
                }
                else {
                    //console.log('KILL this update because from deck');
                }
            },
            getData: function(url) {
                return px.angularDealer.getData(url);
            }
        };
    })();
</script>

